# -*- coding: utf-8 -*-
"""Projeto - Alura.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1kCQyY2zB5p1XhQWislg3qmH1Q85D_MBI

# Configura√ß√£o da API Key e Cliente Gemini
"""

# -*- coding: utf-8 -*-
"""
Descomplica Web - Projeto Final Imers√£o IA Alura + Google Gemini
Vers√£o com tom de voz equilibrado, uso m√≠nimo de emojis e interface Gradio.
"""

import os
from google.colab import userdata # Para Colab
from google import genai
from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types as genai_types
import textwrap
from IPython.display import display, Markdown
import warnings
import gradio as gr

warnings.filterwarnings("ignore")

try:
    # Tenta obter a API Key do userdata do Colab
    os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')
except Exception as e:
    # Mensagem para o caso de n√£o estar no Colab ou falha no userdata
    print(f"Aviso: N√£o foi poss√≠vel obter GOOGLE_API_KEY automaticamente. Erro: {e}")
    print("Se n√£o estiver usando o Google Colab, certifique-se de que a vari√°vel de ambiente GOOGLE_API_KEY est√° configurada.")

# Verifica√ß√£o cr√≠tica da API Key
if not os.environ.get("GOOGLE_API_KEY"):
    raise ValueError("API Key do Google n√£o encontrada. "
                     "No Google Colab, configure-a em 'Segredos'. "
                     "Em outros ambientes, defina a vari√°vel de ambiente GOOGLE_API_KEY.")

client = genai.Client()
MODEL_ID = "gemini-2.0-flash"

"""# Fun√ß√µes Auxiliares"""

def call_agent(agent: Agent, message_text: str) -> str:
    session_service = InMemorySessionService()
    # Usar um ID de sess√£o consistente para esta vers√£o
    session = session_service.create_session(app_name=agent.name, user_id="user_descomplica_web", session_id="session_dw_v3")
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    content = genai_types.Content(role="user", parts=[genai_types.Part(text=message_text)])

    final_response = ""
    for event in runner.run(user_id="user_descomplica_web", session_id="session_dw_v3", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
    return final_response.strip()

def to_markdown(text):
  text = text.replace('‚Ä¢', '  *') # Mant√©m a formata√ß√£o de bullets
  text = text.replace('\n', '  \n') # Mant√©m quebras de linha do Markdown
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))

"""# Defini√ß√£o dos Agentes Especialistas"""

# Agente que fornece informa√ß√µes sobre o 'Descomplica Web'.
def agente_sobre_o_bot(pergunta_usuario: str) -> str:

    agent_sobre_instance = Agent(
        name="AgenteSobreOBot",
        model=MODEL_ID,
        instruction=f"""
            Ol√°! Eu sou o 'Descomplica Web', um assistente digital desenvolvido para ajudar jovens
            a entenderem melhor o universo da tecnologia e da internet.
            Minha fun√ß√£o √© explicar conceitos, tirar d√∫vidas e oferecer orienta√ß√µes sobre:
            * Cria√ß√£o e gerenciamento de senhas seguras.
            * Componentes e funcionamento de URLs (endere√ßos da web).
            * Dicas para realizar pesquisas eficientes no Google.
            * Diferentes formatos de arquivo (como PDF, JPG, DOCX) e seus usos.
            * Termos t√©cnicos comuns em inform√°tica e internet.
            * Pr√°ticas de seguran√ßa online e cidadania digital.

            Estou aqui para tornar a tecnologia mais acess√≠vel e compreens√≠vel.
            Considerando a pergunta: '{pergunta_usuario}', forne√ßa uma resposta clara e informativa sobre minhas capacidades.
            """,
        description="Agente que explica o prop√≥sito e as funcionalidades do 'Descomplica Web'."
    )
    return call_agent(agent_sobre_instance, pergunta_usuario)

# Agente especialista em senhas.
def agente_senhas(pergunta_usuario: str) -> str:
    agent_senhas_instance = Agent(
        name="AgenteDeSenhas",
        model=MODEL_ID,
        instruction=f"""
            Ol√°! Sou o AgenteDeSenhas do sistema 'Descomplica Web'.
            Estou aqui para ajudar voc√™ com quest√µes sobre senhas: como criar senhas fortes,
            entender a import√¢ncia da seguran√ßa de senhas e como proteger suas contas online.
            Meu objetivo √© explicar esses t√≥picos de forma clara e objetiva.
            Respondendo √† sua pergunta: '{pergunta_usuario}'
            """,
        description="Agente que oferece orienta√ß√£o sobre seguran√ßa e cria√ß√£o de senhas."
    )
    return call_agent(agent_senhas_instance, pergunta_usuario)

# Agente especialista em URLs.
def agente_urls(pergunta_usuario: str) -> str:
    agent_urls_instance = Agent(
        name="AgenteDeURLs",
        model=MODEL_ID,
        instruction=f"""
            Ol√°! Sou o AgenteDeURLs do 'Descomplica Web'. Minha especialidade √© ajudar a entender
            os endere√ßos da web (URLs). Posso explicar o que s√£o, como s√£o estruturados
            e o que cada parte de uma URL significa.
            Se voc√™ tem d√∫vidas sobre uma URL espec√≠fica ou sobre o conceito geral, pode perguntar.
            Analisando sua pergunta: '{pergunta_usuario}'
            """,
        description="Agente que explica a estrutura e os componentes de URLs."
    )
    return call_agent(agent_urls_instance, pergunta_usuario)

# Agente especialista em buscas no Google.
def agente_buscas(pergunta_usuario: str) -> str:
    agent_buscas_instance = Agent(
        name="AgenteDeBuscas",
        model=MODEL_ID,
        instruction=f"""
            Ol√°! Sou o AgenteDeBuscas do 'Descomplica Web'.
            Posso ajudar voc√™ a melhorar suas habilidades de pesquisa no Google,
            oferecendo dicas sobre como usar operadores de busca (como aspas, 'site:', 'filetype:')
            para encontrar informa√ß√µes de forma mais precisa.
            Se precisar, tamb√©m posso realizar uma busca sobre um t√≥pico espec√≠fico usando a ferramenta 'google_search'.
            Vamos explorar sua necessidade de busca: '{pergunta_usuario}'
            """,
        description="Agente que auxilia com t√©cnicas de pesquisa no Google e pode realizar buscas.",
        tools=[google_search]
    )
    return call_agent(agent_buscas_instance, pergunta_usuario)

#Agente especialista em formatos de arquivo.
def agente_formatos(pergunta_usuario: str) -> str:
    agent_formatos_instance = Agent(
        name="AgenteDeFormatos",
        model=MODEL_ID,
        instruction=f"""
            Ol√°! Eu sou o AgenteDeFormatos do 'Descomplica Web'.
            Minha fun√ß√£o √© explicar sobre os diferentes formatos de arquivo que encontramos no dia a dia digital,
            como .PDF, .JPG, .DOCX, .MP3, .ZIP, entre outros.
            Posso esclarecer para que servem, suas principais caracter√≠sticas e como s√£o utilizados.
            Importante: eu n√£o realizo convers√µes de arquivos, mas posso explicar os m√©todos comuns para isso.
            Qual sua d√∫vida sobre formatos de arquivo? '{pergunta_usuario}'
            """,
        description="Agente que explica sobre diversos formatos de arquivo e seus usos."
    )
    return call_agent(agent_formatos_instance, pergunta_usuario)

# Agente para esclarecer termos t√©cnicos.
def agente_tira_duvidas_tech(pergunta_usuario: str) -> str:
    agent_tira_duvidas_instance = Agent(
        name="AgenteTiraDuvidasTech",
        model=MODEL_ID,
        instruction=f"""
            Ol√°! Sou o AgenteTiraDuvidasTech do 'Descomplica Web'.
            Se voc√™ encontrou algum termo t√©cnico de inform√°tica, internet ou tecnologia que n√£o compreendeu bem,
            estou aqui para ajudar a esclarecer. Meu objetivo √© explicar esses termos
            de forma simples e direta, para facilitar seu entendimento.
            Qual termo ou conceito voc√™ gostaria de entender melhor? '{pergunta_usuario}'
            """,
        description="Agente que explica termos t√©cnicos e conceitos de tecnologia de forma clara."
    )
    return call_agent(agent_tira_duvidas_instance, pergunta_usuario)

# Agente especialista em cidadania digital e seguran√ßa online.
def agente_cidadania_digital(pergunta_usuario: str) -> str:
    agent_cidadania_digital_instance = Agent(
        name="AgenteCidadaniaDigital",
        model=MODEL_ID,
        instruction=f"""
            Ol√°! Sou o AgenteCidadaniaDigital do 'Descomplica Web'.
            Minha √°rea √© orientar sobre seguran√ßa online e pr√°ticas de cidadania digital.
            Isso inclui como se proteger de amea√ßas virtuais, identificar not√≠cias falsas (fake news),
            a import√¢ncia da privacidade online e como ter um comportamento √©tico e respeitoso na internet.
            Como posso ajudar com sua d√∫vida sobre este tema? '{pergunta_usuario}'
            """,
        description="Agente que oferece orienta√ß√£o sobre seguran√ßa online e comportamento √©tico na internet."
    )
    return call_agent(agent_cidadania_digital_instance, pergunta_usuario)

"""# Defini√ß√£o do Agente Roteador"""

# Agente que analisa a pergunta do usu√°rio e direciona para o especialista correto.
def agente_roteador(pergunta_usuario: str) -> str:
    nomes_agentes = [
        "AgenteSobreOBot",
        "AgenteDeSenhas",
        "AgenteDeURLs",
        "AgenteDeBuscas",
        "AgenteDeFormatos",
        "AgenteTiraDuvidasTech",
        "AgenteCidadaniaDigital"
    ]
    nomes_agentes_str = ", ".join([f"'{nome}'" for nome in nomes_agentes])

    roteador_instance = Agent(
        name="AgenteRoteadorDescomplicaWeb",
        model=MODEL_ID,
        instruction=f"""
            Voc√™ √© o sistema de roteamento do 'Descomplica Web', um assistente focado em ajudar jovens
            com quest√µes de tecnologia. Sua tarefa √© analisar a pergunta do usu√°rio e encaminh√°-la
            ao agente especialista mais adequado.

            Os especialistas dispon√≠veis s√£o:
            - 'AgenteSobreOBot': Para perguntas sobre o pr√≥prio assistente 'Descomplica Web' (o que ele faz, suas capacidades). Ex: "O que voc√™ √© capaz de fazer?", "Quem √© voc√™?"
            - 'AgenteDeSenhas': Para d√∫vidas sobre cria√ß√£o, seguran√ßa e gerenciamento de senhas. Ex: "Como criar uma senha forte?", "minha senha 'abc123' √© segura?"
            - 'AgenteDeURLs': Para explicar partes de um endere√ßo web (URL). Ex: "O que significa 'https' em um link?", "analise a URL: exemplo.com/pagina"
            - 'AgenteDeBuscas': Para dicas sobre como pesquisar no Google e realizar buscas de informa√ß√µes. Ex: "Como encontrar informa√ß√µes sobre hist√≥ria do Brasil?", "dicas para pesquisa online"
            - 'AgenteDeFormatos': Para explicar tipos de arquivos (PDF, JPG, etc.) e quest√µes relacionadas a formatos. Ex: "O que √© um arquivo .RAR?", "para que serve o formato .PNG?"
            - 'AgenteTiraDuvidasTech': Para explicar termos t√©cnicos e conceitos b√°sicos de inform√°tica/internet. Ex: "O que √© 'cookies' de um site?", "o que significa 'firewall'?"
            - 'AgenteCidadaniaDigital': Para conselhos sobre seguran√ßa online, fake news e comportamento √©tico na internet. Ex: "Como identificar uma not√≠cia falsa?", "√© seguro compartilhar dados pessoais em jogos?"

            Analise a pergunta do usu√°rio: '{pergunta_usuario}'

            Responda APENAS com o NOME EXATO de um dos seguintes agentes especialistas: {nomes_agentes_str}.
            Se a pergunta n√£o se encaixar claramente em nenhum especialista, for muito vaga, ou n√£o estiver relacionada aos t√≥picos que os agentes cobrem, responda 'NaoSeiQualAgente'.
            Selecione o agente que melhor corresponde √† inten√ß√£o principal da pergunta.
            """,
        description="Agente que direciona a pergunta do usu√°rio para o especialista correto, com tom equilibrado."
    )
    nome_do_agente_especialista = call_agent(roteador_instance, f"Analisar pergunta para roteamento: {pergunta_usuario}")
    if nome_do_agente_especialista in nomes_agentes or nome_do_agente_especialista == "NaoSeiQualAgente":
        return nome_do_agente_especialista
    else:
        # Log interno para o desenvolvedor, caso o Gemini n√£o siga a instru√ß√£o
        print(f"Alerta de Roteamento: AgenteRoteador retornou um nome inesperado: '{nome_do_agente_especialista}'. Padronizando para NaoSeiQualAgente.")
        return "NaoSeiQualAgente"

"""# L√≥gica do Chatbot para a Interface Gradio"""

def chatbot_interface(pergunta_usuario: str) -> str:
    """
    Fun√ß√£o principal que processa a pergunta do usu√°rio e retorna a resposta do bot.
    Esta fun√ß√£o ser√° usada pela interface Gradio.
    """
    if not pergunta_usuario or pergunta_usuario.strip() == "":
        return "Por favor, digite uma pergunta v√°lida."

    # Logs no console (opcional, mas √∫til para debug no Colab)
    print(f"\n[Gradio Input] Pergunta recebida: '{pergunta_usuario}'")
    try:
        especialista_escolhido = agente_roteador(pergunta_usuario)
        print(f"[Gradio Logic] Especialista escolhido: {especialista_escolhido}")

        resposta_final = ""
        mapa_agentes = {
            "AgenteSobreOBot": agente_sobre_o_bot,
            "AgenteDeSenhas": agente_senhas,
            "AgenteDeURLs": agente_urls,
            "AgenteDeBuscas": agente_buscas,
            "AgenteDeFormatos": agente_formatos,
            "AgenteTiraDuvidasTech": agente_tira_duvidas_tech,
            "AgenteCidadaniaDigital": agente_cidadania_digital,
        }

        if especialista_escolhido in mapa_agentes:
            resposta = mapa_agentes[especialista_escolhido](pergunta_usuario)
            resposta_final = resposta.replace("**", "")
        elif especialista_escolhido == "NaoSeiQualAgente":
            resposta_final = (
                "Desculpe, n√£o consegui direcionar sua pergunta para um especialista espec√≠fico ou "
                "o tema parece estar fora do meu escopo atual.\n"
                "Voc√™ pode tentar reformular sua pergunta ou perguntar sobre os seguintes t√≥picos:\n"
                "  * Cria√ß√£o e seguran√ßa de senhas\n"
                "  * Entendimento de endere√ßos da web (URLs)\n"
                "  * Dicas para pesquisas online\n"
                "  * Formatos de arquivo (PDF, JPG, etc.)\n"
                "  * Explica√ß√£o de termos de tecnologia\n"
                "  * Seguran√ßa e comportamento na internet\n"
                "  * O que eu sou e o que posso fazer."
            )
        else:
            resposta_final = "Ocorreu um erro ao tentar processar sua pergunta. Por favor, tente novamente."
            print(f"[Gradio Error] Especialista '{especialista_escolhido}' n√£o reconhecido.")

        print(f"[Gradio Output] Resposta gerada (primeiros 100 chars): {resposta_final[:100]}")
        return resposta_final if resposta_final else "N√£o foi poss√≠vel gerar uma resposta para esta pergunta."

    except Exception as e:
        print(f"[Gradio Error] Exce√ß√£o durante o processamento: {e}")
        # Retornar uma mensagem de erro amig√°vel para a interface
        return f"Ocorreu um erro ao processar sua pergunta: {str(e)}. Por favor, tente novamente."

if __name__ == "__main__":
    if not os.environ.get("GOOGLE_API_KEY"):
        print("ERRO CR√çTICO: A API Key do Google (GOOGLE_API_KEY) n√£o est√° configurada.")
        print("No Google Colab, certifique-se de que ela est√° definida na se√ß√£o 'Segredos'.")
        print("Em outros ambientes, configure a vari√°vel de ambiente correspondente.")
        print("O programa n√£o pode continuar sem a API Key.")
    else:
        print("API Key encontrada. Iniciando a interface do Descomplica Web com Gradio...")
        print("Aguarde alguns instantes para a interface carregar e o link p√∫blico ser gerado (se estiver no Colab).")

        # Define a interface Gradio
        iface = gr.Interface(
            fn=chatbot_interface,
            allow_flagging="never",
            inputs=gr.Textbox(label="Pergunta", placeholder="Digite sua pergunta sobre tecnologia aqui... Pressione Enter ou clique em 'Enviar'.", lines=3,),
            outputs=gr.Textbox(label="Resposta do Descomplica Web", lines=10, interactive=False),
            title="ü§ñ Descomplica Web ü§ñ",
            description=(
                "Seu assistente para tirar d√∫vidas sobre senhas, URLs, buscas na internet, formatos de arquivo, termos t√©cnicos e seguran√ßa online.\n"
                "Feito com IA Google Gemini e Agentes Google ADK.\n\n"
                "Para limpar a conversa e come√ßar de novo, use o bot√£o 'Clear'.\n"
                "Para sair da aplica√ß√£o, simplesmente feche esta aba ou janela do navegador."
            ),
            examples=[
                ["Quem √© voc√™ e o que voc√™ faz?"],
                ["Como fa√ßo para criar uma senha realmente forte?"],
                ["O que significa HTTPS em um endere√ßo de site?"],
                ["Como posso achar informa√ß√µes sobre a hist√≥ria da programa√ß√£o para um trabalho da escola?"],
                ["O que √© um arquivo PDF e para que ele serve?"],
                ["O que quer dizer 'phishing'?"],
                ["√â seguro usar redes Wi-Fi p√∫blicas?"]
            ],
            theme=gr.themes.Soft()
        )

        # Inicia a interface
        # debug=True √© √∫til para ver logs do Gradio no console.
        try:
            iface.launch(share=False, debug=True)
            print("Interface Gradio iniciada. Verifique o output acima para o link local e o link p√∫blico (se share=True).")
        except Exception as e:
            print(f"Erro ao iniciar a interface Gradio: {e}")
            print("Verifique se a porta 7860 (padr√£o do Gradio) est√° dispon√≠vel ou tente reiniciar o kernel do Colab.")
